---
// dashboard.astro - Dashboard hÃ­brido que combina funcionalidad backend + componentes avanzados
import type { Task, User } from "../types";
import TaskList from "../components/TaskList.astro";
import TaskForm from "../components/TaskForm.astro";
import ConfirmModal from "../components/ConfirmModal.astro";
---

<html lang="es">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <title>Dashboard - TurifyTasks</title>
        <link rel="stylesheet" href="/src/styles/components/Dashboard.css" />
    </head>
    <body>
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">âœ“</div>
                    <span>TurifyTasks</span>
                </div>
                <div class="user-section">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span id="userEmail">Cargando...</span>
                    </div>
                    <button class="logout-btn" id="logoutBtn"
                        >Cerrar sesiÃ³n</button
                    >
                </div>
            </div>
        </header>

        <div class="dashboard-layout">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">Filtros</div>
                    <div class="sidebar-subtitle">Organiza tus tareas</div>
                </div>

                <nav class="sidebar-nav">
                    <button class="sidebar-item active" data-filter="inbox">
                        <div class="sidebar-item-content">
                            <span>ğŸ“¥ Bandeja de entrada</span>
                            <span class="sidebar-item-count" id="inboxCount"
                                >0</span
                            >
                        </div>
                    </button>
                    <button class="sidebar-item" data-filter="today">
                        <div class="sidebar-item-content">
                            <span>ğŸ“… Hoy</span>
                            <span class="sidebar-item-count" id="todayCount"
                                >0</span
                            >
                        </div>
                    </button>
                    <button class="sidebar-item" data-filter="upcoming">
                        <div class="sidebar-item-content">
                            <span>ğŸ“‹ PrÃ³ximas</span>
                            <span class="sidebar-item-count" id="upcomingCount"
                                >0</span
                            >
                        </div>
                    </button>
                    <button class="sidebar-item" data-filter="important">
                        <div class="sidebar-item-content">
                            <span>â­ Importantes</span>
                            <span class="sidebar-item-count" id="importantCount"
                                >0</span
                            >
                        </div>
                    </button>
                    <button class="sidebar-item" data-filter="completed">
                        <div class="sidebar-item-content">
                            <span>âœ… Completadas</span>
                            <span class="sidebar-item-count" id="completedCount"
                                >0</span
                            >
                        </div>
                    </button>
                </nav>
            </aside>

            <!-- Main content -->
            <main class="main-content">
                <div class="main-header">
                    <h1 class="page-title" id="pageTitle">
                        Bandeja de entrada
                    </h1>
                    <p class="page-subtitle">
                        Gestiona tus tareas de manera eficiente y organizada
                    </p>
                </div>

                <!-- BÃºsqueda y filtros -->
                <div class="search-section">
                    <div class="search-row">
                        <input
                            type="text"
                            class="search-input"
                            placeholder="ğŸ” Buscar tareas..."
                            id="searchInput"
                        />
                        <select class="filter-select" id="priorityFilter">
                            <option value="">Todas las prioridades</option>
                            <option value="high">ğŸ”´ Alta prioridad</option>
                            <option value="medium">ğŸŸ¡ Prioridad media</option>
                            <option value="low">ğŸŸ¢ Baja prioridad</option>
                        </select>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="actions-section">
                    <button class="action-btn primary" id="newTaskBtn">
                        â• Nueva Tarea
                    </button>
                    <button class="action-btn secondary" id="refreshBtn">
                        ğŸ”„ Actualizar
                    </button>
                </div>

                <!-- SecciÃ³n de tareas -->
                <div class="tasks-section">
                    <div class="tasks-header">
                        <h2 class="tasks-title" id="sectionTitle">
                            Bandeja de entrada
                        </h2>
                        <span class="tasks-counter" id="taskCounter">0/0</span>
                    </div>
                    <div class="tasks-content">
                        <div class="loading-state" id="loadingState">
                            â³ Cargando tareas...
                        </div>
                        <div id="tasksContainer">
                            <!-- Las tareas se renderizan aquÃ­ -->
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modal de formulario (usa tu componente avanzado) -->
        <TaskForm />

        <!-- Contenedor de notificaciones -->
        <div class="toast-container" id="toastContainer"></div>

        <script type="module" src="/src/scripts/dashboard.js"></script>
        <script>
            // Espera a que el mÃ³dulo dashboard.js cargue y exponga la funciÃ³n
            window.addEventListener("DOMContentLoaded", function () {
                // Reintenta hasta que la funciÃ³n estÃ© disponible
                let tries = 0;
                const interval = setInterval(function () {
                    // Busca la funciÃ³n en los mÃ³dulos importados
                    if (window.handleDelete || window.deleteTask) {
                        window.deleteTask =
                            window.handleDelete || window.deleteTask;
                        clearInterval(interval);
                        console.log(
                            "[dashboard.astro] window.deleteTask asignada:",
                            window.deleteTask
                        );
                    }
                    if (++tries > 30) {
                        clearInterval(interval);
                        console.warn(
                            "[dashboard.astro] No se pudo asignar window.deleteTask"
                        );
                    }
                }, 100);
            });
        </script>
        <script>
            // Espera a que el DOM y dashboard.js estÃ©n listos
            window.addEventListener("DOMContentLoaded", function () {
                // Espera a que dashboard.js exponga deleteTask en window
                if (window.deleteTask) {
                    window.handleDelete = window.deleteTask;
                } else {
                    // Si no estÃ¡ disponible aÃºn, reintenta hasta que lo estÃ©
                    let tries = 0;
                    const interval = setInterval(function () {
                        if (window.deleteTask) {
                            window.handleDelete = window.deleteTask;
                            clearInterval(interval);
                        } else if (++tries > 20) {
                            clearInterval(interval);
                        }
                    }, 100);
                }
            });
        </script>

        <!-- Modal de confirmaciÃ³n para eliminar tareas -->
        <ConfirmModal
            id="deleteTaskModal"
            title="Eliminar tarea"
            message="Â¿EstÃ¡s seguro de que quieres eliminar esta tarea? Esta acciÃ³n no se puede deshacer."
            confirmText="Eliminar"
            cancelText="Cancelar"
        />
    </body>
</html>
